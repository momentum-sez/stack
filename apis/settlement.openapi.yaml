openapi: 3.1.0
info:
  title: MEZ Settlement API
  version: 0.4.44
  description: |
    Corridor settlement operations: multilateral netting, bridge
    route discovery, and ISO 20022 pacs.008 payment instruction
    generation.

    The settlement engine computes net positions from gross
    obligations, finds optimal cross-corridor routes via Dijkstra,
    and generates SWIFT-compatible XML payment instructions.
  license:
    name: BUSL-1.1
    identifier: BUSL-1.1

servers:
  - url: https://{zone_host}
    variables:
      zone_host:
        default: localhost:8080

security:
  - bearerAuth: []

paths:
  /v1/corridors/{id}/settlement/compute:
    post:
      summary: Compute multilateral netting for a corridor
      operationId: computeSettlement
      description: |
        Accepts a set of gross obligations between parties and computes
        net positions via multilateral netting. Returns the netting
        reduction, net positions per party, and settlement legs.

        Obligations must be between 1 and 10,000 items.
      parameters:
        - $ref: '#/components/parameters/CorridorId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SettlementComputeRequest'
      responses:
        '200':
          description: Settlement plan computed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SettlementPlanResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/corridors/route:
    post:
      summary: Find an optimal route between two zones
      operationId: findRoute
      description: |
        Uses Dijkstra's algorithm to find the optimal path between
        source and target zones through the corridor graph. Returns
        per-hop fee and settlement time estimates.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RouteRequest'
      responses:
        '200':
          description: Route found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RouteResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: No route found between source and target
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/corridors/{id}/settlement/instruct:
    post:
      summary: Generate ISO 20022 pacs.008 payment instructions
      operationId: generateInstructions
      description: |
        Takes settlement legs and generates SWIFT-compatible pacs.008
        XML payment instructions. Each leg produces one pacs.008 message
        with BIC routing, amount, and currency.

        Legs must be between 1 and 1,000 items. BIC codes must not
        exceed 11 characters. Amounts must be positive.
      parameters:
        - $ref: '#/components/parameters/CorridorId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InstructionRequest'
      responses:
        '200':
          description: Instructions generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InstructionResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Zone-issued JWT with role claims (operator, regulator, auditor).

  parameters:
    CorridorId:
      name: id
      in: path
      required: true
      description: Corridor UUID.
      schema:
        type: string
        format: uuid
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: Client-generated UUID for at-most-once delivery.
      schema:
        type: string
        format: uuid

  responses:
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    UnprocessableEntity:
      description: Schema validation failed or business rule violation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'

  schemas:
    ProblemDetail:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs.
      additionalProperties: false
      required: [type, title, status]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri

    SettlementComputeRequest:
      type: object
      additionalProperties: false
      properties:
        obligations:
          type: array
          minItems: 1
          maxItems: 10000
          items:
            $ref: '#/components/schemas/ObligationInput'

    ObligationInput:
      type: object
      additionalProperties: false
      required: [from_party, to_party, amount, currency]
      properties:
        from_party:
          type: string
        to_party:
          type: string
        amount:
          type: integer
          description: Obligation amount in minor units.
        currency:
          type: string
        priority:
          type: integer

    SettlementPlanResponse:
      type: object
      additionalProperties: false
      required: [corridor_id, obligations_processed, obligations_skipped, gross_total, net_total, reduction_bps, net_positions, settlement_legs]
      properties:
        corridor_id:
          type: string
          format: uuid
        obligations_processed:
          type: integer
          minimum: 0
        obligations_skipped:
          type: integer
          minimum: 0
        gross_total:
          type: integer
        net_total:
          type: integer
        reduction_bps:
          type: integer
          minimum: 0
          description: Netting reduction in basis points.
        net_positions:
          type: array
          items:
            $ref: '#/components/schemas/NetPositionResponse'
        settlement_legs:
          type: array
          items:
            $ref: '#/components/schemas/SettlementLegResponse'

    NetPositionResponse:
      type: object
      additionalProperties: false
      required: [party_id, currency, receivable, payable, net]
      properties:
        party_id:
          type: string
        currency:
          type: string
        receivable:
          type: integer
        payable:
          type: integer
        net:
          type: integer

    SettlementLegResponse:
      type: object
      additionalProperties: false
      required: [from_party, to_party, amount, currency]
      properties:
        from_party:
          type: string
        to_party:
          type: string
        amount:
          type: integer
        currency:
          type: string

    RouteRequest:
      type: object
      additionalProperties: false
      required: [source, target]
      properties:
        source:
          type: string
          description: Source zone/jurisdiction identifier.
        target:
          type: string
          description: Target zone/jurisdiction identifier.
        default_fee_bps:
          type: integer
          minimum: 0
          description: Default fee in basis points for corridors without explicit fee.
        default_settlement_time_secs:
          type: integer
          minimum: 0
          description: Default settlement time in seconds for corridors without explicit time.

    RouteResponse:
      type: object
      additionalProperties: false
      required: [source, target, hop_count, total_fee_bps, total_settlement_time_secs, hops]
      properties:
        source:
          type: string
        target:
          type: string
        hop_count:
          type: integer
          minimum: 0
        total_fee_bps:
          type: integer
          minimum: 0
        total_settlement_time_secs:
          type: integer
          minimum: 0
        hops:
          type: array
          items:
            $ref: '#/components/schemas/RouteHopResponse'

    RouteHopResponse:
      type: object
      additionalProperties: false
      required: [from, to, corridor_id, fee_bps, settlement_time_secs]
      properties:
        from:
          type: string
        to:
          type: string
        corridor_id:
          type: string
        fee_bps:
          type: integer
          minimum: 0
        settlement_time_secs:
          type: integer
          minimum: 0

    InstructionRequest:
      type: object
      additionalProperties: false
      properties:
        instructing_agent_bic:
          type: string
          maxLength: 11
          description: BIC of the instructing agent.
        legs:
          type: array
          minItems: 1
          maxItems: 1000
          items:
            $ref: '#/components/schemas/InstructionLeg'

    InstructionLeg:
      type: object
      additionalProperties: false
      required: [from_party, from_bic, to_party, to_bic, amount, currency]
      properties:
        from_party:
          type: string
        from_bic:
          type: string
          maxLength: 11
        from_account:
          type: string
        to_party:
          type: string
        to_bic:
          type: string
          maxLength: 11
        to_account:
          type: string
        amount:
          type: integer
          exclusiveMinimum: 0
        currency:
          type: string

    InstructionResponse:
      type: object
      additionalProperties: false
      required: [corridor_id, instructions_generated, instructions]
      properties:
        corridor_id:
          type: string
          format: uuid
        instructions_generated:
          type: integer
          minimum: 0
        errors:
          type: array
          items:
            type: string
        instructions:
          type: array
          items:
            $ref: '#/components/schemas/Pacs008Output'

    Pacs008Output:
      type: object
      additionalProperties: false
      required: [leg_index, from_party, to_party, amount, currency, xml]
      properties:
        leg_index:
          type: integer
          minimum: 0
        from_party:
          type: string
        to_party:
          type: string
        amount:
          type: integer
        currency:
          type: string
        xml:
          type: string
          description: SWIFT pacs.008 XML message.
