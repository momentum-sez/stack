name: ci
on:
  push:
  pull_request:

jobs:
  rust:
    name: Rust workspace checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mez
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: mez

      - name: Check formatting
        run: cargo fmt --check --all

      - name: Clippy (warnings as errors)
        run: cargo clippy --workspace -- -D warnings

      - name: Guard — serde_json preserve_order must NOT be enabled
        run: |
          if cargo tree -e features -i serde_json 2>&1 | grep -qi "preserve.order\|indexmap"; then
            echo "FATAL: serde_json preserve_order detected — all digests would be corrupted"
            cargo tree -e features -i serde_json
            exit 1
          fi
          echo "OK: serde_json uses BTreeMap (preserve_order not active)"

      - name: Run tests
        run: cargo test --workspace

      - name: Security audit
        run: |
          cargo install cargo-audit --locked
          cargo audit

      - name: Build docs
        run: cargo doc --workspace --no-deps

  schema-validation:
    name: Schema & artifact integrity checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: mez

      # P1-SCHEMA-001: Validate schemas with Draft 2020-12 compilation + $ref closure.
      # Replaces old Python json.load() parse check. The Rust SchemaValidator
      # compiles every *.schema.json with Draft 2020-12, resolves all $ref URIs,
      # and reports structural/compile errors.
      - name: Validate all schemas (Draft 2020-12 + $ref closure)
        working-directory: mez
        run: cargo test --package mez-schema -- test_load_all_schemas test_ref_resolution

      # P1-SCHEMA-002: Schema $id URI consistency (hard failure).
      # All schemas must use the canonical domain: schemas.momentum-ez.org/mez/
      # Also detects schemas that are missing $id entirely.
      - name: Guard — schema $id URI consistency
        run: |
          CANONICAL="schemas.momentum-ez.org/mez/"
          FAIL=0

          # Check 1: Non-canonical $id URIs
          BAD_IDS=$(grep -rn '"$id"' schemas/ | grep -v "$CANONICAL" | grep -v '.schema.json":' || true)
          if [ -n "$BAD_IDS" ]; then
            echo "FAIL: Non-canonical schema \$id URIs found (P1-SCHEMA-002):"
            echo "$BAD_IDS"
            echo "Expected domain: $CANONICAL"
            FAIL=1
          fi

          # Check 2: Schemas missing $id entirely
          MISSING_IDS=$(grep -rL '"$id"' schemas/*.schema.json || true)
          if [ -n "$MISSING_IDS" ]; then
            echo "FAIL: Schemas missing \$id field:"
            echo "$MISSING_IDS"
            FAIL=1
          fi

          [ "$FAIL" -eq 0 ] || exit 1
          echo "OK: All schema \$id URIs use canonical domain"

      # P0-DEPLOY-001: No default credentials in deploy paths.
      - name: Guard — no default credentials in deploy paths
        run: |
          if grep -rn 'POSTGRES_PASSWORD:-mez\|POSTGRES_PASSWORD=mez\|GRAFANA_PASSWORD:-admin\|password.*=.*mez' deploy/; then
            echo "FAIL: Default credentials found in deploy paths (P0-DEPLOY-001)"
            exit 1
          fi
          echo "OK: No default credentials in deploy paths"

      # P0-ZK-001: Release builds must not enable mock proof features.
      # Checks that "mock" is NOT in the default feature set for mez-zkp.
      # The mock feature is an opt-in marker for dev/test; release builds
      # must not include it in defaults.
      - name: Guard — no mock proof backend in release
        working-directory: mez
        run: |
          DEFAULTS=$(cargo metadata --format-version 1 --no-deps 2>/dev/null | \
            python3 -c "
          import sys, json
          pkgs = json.load(sys.stdin)['packages']
          zkp = [p for p in pkgs if p['name'] == 'mez-zkp']
          if zkp:
              defaults = zkp[0].get('features', {}).get('default', [])
              print(' '.join(defaults))
          else:
              print('')
          " 2>/dev/null || echo "")
          if echo "$DEFAULTS" | grep -qi "mock"; then
            echo "FATAL: mez-zkp default features include 'mock': $DEFAULTS"
            echo "Mock proof backends MUST NOT be in default features (P0-ZK-001)"
            exit 1
          fi
          echo "OK: mez-zkp default features do not include mock ($DEFAULTS)"

      # P1-SCHEMA-003: additionalProperties policy on security-critical schemas.
      - name: Guard — additionalProperties policy on security-critical schemas
        working-directory: mez
        run: cargo test --package mez-schema -- test_audit_current_schema_state

      - name: Verify trade playbook artifact graph closure
        run: |
          test -f docs/examples/trade/dist/artifacts/cas-index.json || { echo "SKIP: trade playbook artifacts not present"; exit 0; }
          test -f docs/examples/trade/dist/manifest.playbook.root.json
          test -f docs/examples/trade/dist/dashboard.json
          echo "OK: Trade playbook artifact closure verified"
