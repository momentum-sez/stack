openapi: 3.1.0
info:
  title: MEZ Corridor State API
  version: 0.4.44
  description: |
    Corridor lifecycle operations: creation, typestate transitions,
    receipt chain management, fork resolution, anchor verification,
    and finality status.

    Corridors are bilateral state channels connecting two jurisdictional
    zones. Each corridor maintains a receipt chain (hash-chain + MMR)
    for cross-border transaction evidence.

    All mutating endpoints are idempotent when called with the same
    `Idempotency-Key` header value.
  license:
    name: BUSL-1.1
    identifier: BUSL-1.1

servers:
  - url: https://{zone_host}/api
    variables:
      zone_host:
        default: localhost:8080

security:
  - bearerAuth: []

paths:
  /v1/corridors:
    get:
      summary: List corridors with pagination
      operationId: listCorridors
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: Maximum number of items to return.
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of items to skip.
      responses:
        '200':
          description: Paginated corridor list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedCorridorList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'
    post:
      summary: Create a new corridor in DRAFT state
      operationId: createCorridor
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCorridorRequest'
      responses:
        '201':
          description: Corridor created in DRAFT state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorridorRecord'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/corridors/{id}:
    get:
      summary: Get corridor by ID
      operationId: getCorridor
      parameters:
        - $ref: '#/components/parameters/CorridorId'
      responses:
        '200':
          description: Corridor details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorridorRecord'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/corridors/{id}/transition:
    put:
      summary: Transition a corridor's lifecycle state
      description: |
        Transitions a corridor through the typestate machine:
        DRAFT → PENDING → ACTIVE → HALTED/SUSPENDED → DEPRECATED.

        Evidence digests are required for security-critical transitions:
        - DRAFT→PENDING: bilateral agreement digest
        - PENDING→ACTIVE: regulatory approval digest
        - ACTIVE→HALTED: halt evidence digest
        - SUSPENDED→ACTIVE: resolution attestation digest
      operationId: transitionCorridor
      parameters:
        - $ref: '#/components/parameters/CorridorId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransitionCorridorRequest'
      responses:
        '200':
          description: Corridor transitioned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorridorRecord'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/corridors/state/propose:
    post:
      summary: Propose a receipt to the corridor's receipt chain
      description: |
        Appends a receipt to the receipt chain. The server computes the
        canonical digest via CanonicalBytes → SHA-256, validates chain
        integrity (prev_root == final_state_root), and appends to the MMR.
      operationId: proposeReceipt
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProposeReceiptRequest'
      responses:
        '200':
          description: Receipt appended to chain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReceiptProposalResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/corridors/state/fork-resolve:
    post:
      summary: Resolve a fork between two competing receipt branches
      description: |
        Evaluates two competing branches using evidence-driven fork
        resolution with signed watcher attestations (P0-FORK-001).
        Selection criteria: verified attestation count, timestamp
        bounds, lexicographic candidate root.
      operationId: forkResolve
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForkResolveRequest'
      responses:
        '200':
          description: Fork resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ForkResolveResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/corridors/state/anchor:
    post:
      summary: Anchor a corridor commitment to L1
      description: |
        Phase 2 feature. Currently returns 501 Not Implemented.
        Will anchor corridor state commitments to an L1 chain
        for finality proofs.
      operationId: anchorCommitment
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '501':
          description: Not implemented — Phase 2 feature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/corridors/state/finality-status:
    post:
      summary: Compute finality status for a corridor commitment
      description: |
        Phase 2 feature. Currently returns 501 Not Implemented.
        Will compute finality status based on L1 anchor confirmations.
      operationId: finalityStatus
      responses:
        '501':
          description: Not implemented — Phase 2 feature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Zone-issued JWT with role claims (operator, regulator, auditor).

  parameters:
    CorridorId:
      name: id
      in: path
      required: true
      description: Corridor UUID.
      schema:
        type: string
        format: uuid
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: Client-generated UUID for at-most-once delivery.
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Malformed request body or parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    UnprocessableEntity:
      description: Schema validation failed or business rule violation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'

  schemas:
    ProblemDetail:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs.
      additionalProperties: false
      required: [type, title, status]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri

    CreateCorridorRequest:
      type: object
      additionalProperties: false
      required: [jurisdiction_a, jurisdiction_b]
      properties:
        jurisdiction_a:
          type: string
          minLength: 1
          maxLength: 255
          description: Jurisdiction identifier for zone A.
        jurisdiction_b:
          type: string
          minLength: 1
          maxLength: 255
          description: Jurisdiction identifier for zone B.

    TransitionCorridorRequest:
      type: object
      additionalProperties: false
      required: [target_state]
      properties:
        target_state:
          type: string
          enum: [DRAFT, PENDING, ACTIVE, HALTED, SUSPENDED, DEPRECATED]
          description: Target corridor lifecycle state.
        evidence_digest:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: SHA-256 hex digest of the evidence supporting this transition.
        reason:
          type: string
          description: Human-readable reason for the transition.

    ProposeReceiptRequest:
      type: object
      additionalProperties: false
      required: [corridor_id, payload]
      properties:
        corridor_id:
          type: string
          format: uuid
          description: Corridor to append this receipt to.
        payload:
          type: object
          description: Transaction payload to commit to the receipt chain.
        lawpack_digest_set:
          type: array
          items:
            type: string
          description: Lawpack digest set governing this receipt.
        ruleset_digest_set:
          type: array
          items:
            type: string
          description: Ruleset digest set governing this receipt.

    ReceiptProposalResponse:
      type: object
      additionalProperties: false
      required: [corridor_id, sequence, prev_root, next_root, mmr_root, chain_height, timestamp]
      properties:
        corridor_id:
          type: string
          format: uuid
        sequence:
          type: integer
          minimum: 0
          description: Sequence number of this receipt in the chain (0-indexed).
        prev_root:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: Hash-chain head (final_state_root) before this receipt.
        next_root:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: Canonical digest of the receipt payload.
        mmr_root:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: Current MMR root after appending.
        chain_height:
          type: integer
          minimum: 0
          description: Current chain height after appending.
        timestamp:
          type: string
          format: date-time
          description: Receipt creation timestamp.

    ForkResolveRequest:
      type: object
      additionalProperties: false
      required: [branch_a, branch_b]
      properties:
        branch_a:
          $ref: '#/components/schemas/ForkBranchInput'
        branch_b:
          $ref: '#/components/schemas/ForkBranchInput'

    ForkBranchInput:
      type: object
      additionalProperties: false
      required: [receipt_digest, timestamp, next_root]
      properties:
        receipt_digest:
          type: string
          minLength: 1
          description: Hex digest of the branch's receipt content.
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp of the branch's receipt.
        next_root:
          type: string
          pattern: '^[a-f0-9]{64}$'
          description: The receipt's next_root digest.

    ForkResolveResponse:
      type: object
      additionalProperties: false
      required: [winning_branch, losing_branch, resolution_reason]
      properties:
        winning_branch:
          type: string
          description: Digest of the winning branch.
        losing_branch:
          type: string
          description: Digest of the losing branch.
        resolution_reason:
          type: string
          description: Reason the winning branch was selected.

    CorridorRecord:
      type: object
      additionalProperties: false
      required: [id, jurisdiction_a, jurisdiction_b, state, transition_log, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        jurisdiction_a:
          type: string
        jurisdiction_b:
          type: string
        state:
          type: string
          enum: [DRAFT, PENDING, ACTIVE, HALTED, SUSPENDED, DEPRECATED]
          description: Current corridor lifecycle state.
        transition_log:
          type: array
          items:
            $ref: '#/components/schemas/TransitionRecord'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TransitionRecord:
      type: object
      additionalProperties: false
      required: [from_state, to_state, timestamp]
      properties:
        from_state:
          type: string
          enum: [DRAFT, PENDING, ACTIVE, HALTED, SUSPENDED, DEPRECATED]
        to_state:
          type: string
          enum: [DRAFT, PENDING, ACTIVE, HALTED, SUSPENDED, DEPRECATED]
        timestamp:
          type: string
          format: date-time
        evidence_digest:
          type: string
          pattern: '^[a-f0-9]{64}$'

    PaginatedCorridorList:
      type: object
      additionalProperties: false
      required: [items, total]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/CorridorRecord'
        total:
          type: integer
          minimum: 0
