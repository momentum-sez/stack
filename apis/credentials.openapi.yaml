openapi: 3.1.0
info:
  title: MEZ Credentials API
  version: 0.4.44
  description: |
    Credential issuance and verification endpoints. Issues signed
    W3C Verifiable Credentials on compliance evaluation results and
    verifies VCs presented by counterparties.

    The compliance tensor produces an evaluation; this API signs it
    into a VC that can be transported, stored, and independently
    verified using the zone's Ed25519 public key.
  license:
    name: BUSL-1.1
    identifier: BUSL-1.1

servers:
  - url: https://{zone_host}
    variables:
      zone_host:
        default: localhost:8080

security:
  - bearerAuth: []

paths:
  /v1/assets/{id}/credentials/compliance:
    post:
      summary: Evaluate compliance and issue a signed Verifiable Credential
      operationId: issueComplianceCredential
      description: |
        Runs the 20-domain compliance tensor on the asset. If the evaluation
        is passing (all mandatory domains compliant), constructs and signs
        a W3C Verifiable Credential attesting to the evaluation result.

        If the evaluation is not passing, the credential field is null and
        the response explains which domains are blocking.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Asset ID (UUID).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComplianceCredentialRequest'
      responses:
        '200':
          description: Compliance evaluated; credential issued if passing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceCredentialResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/credentials/verify:
    post:
      summary: Verify a Verifiable Credential
      operationId: verifyCredential
      description: |
        Accepts a W3C Verifiable Credential, resolves the verification
        method against known zone keys, and returns the verification
        result. Currently resolves only the zone's own key; external
        DID resolution is a Phase 2 feature.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: W3C Verifiable Credential JSON object.
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Zone-issued JWT with role claims (operator, regulator, auditor).

  responses:
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    UnprocessableEntity:
      description: Schema validation failed or business rule violation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'

  schemas:
    ProblemDetail:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs.
      additionalProperties: false
      required: [type, title, status]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri

    ComplianceCredentialRequest:
      type: object
      additionalProperties: false
      properties:
        entity_id:
          type: string
          format: uuid
          description: Entity ID for entity-specific evaluation.
        attestations:
          type: object
          additionalProperties:
            type: object
            additionalProperties: false
            properties:
              status:
                type: string
          description: |
            Attestation evidence per compliance domain.
            Keys are domain names (e.g., "aml", "kyc", "sanctions").

    ComplianceCredentialResponse:
      type: object
      additionalProperties: false
      required: [evaluation]
      properties:
        evaluation:
          type: object
          additionalProperties: false
          required: [overall_status, domain_count]
          properties:
            overall_status:
              type: string
            domain_count:
              type: integer
              minimum: 0
            domain_results:
              type: array
              items:
                type: object
                additionalProperties: false
                properties:
                  domain:
                    type: string
                  status:
                    type: string
            passing_domains:
              type: array
              items:
                type: string
            blocking_domains:
              type: array
              items:
                type: string
            tensor_commitment:
              type: string
              description: SHA-256 digest of the compliance tensor state.
        credential:
          type: object
          description: Signed W3C Verifiable Credential (null if not passing).
        reason:
          type: string
          description: Reason the credential was not issued.

    VerificationResponse:
      type: object
      additionalProperties: false
      required: [verified, proof_count, results, issuer, credential_type]
      properties:
        verified:
          type: boolean
          description: Whether all proofs verified successfully.
        proof_count:
          type: integer
          minimum: 0
        results:
          type: array
          items:
            $ref: '#/components/schemas/ProofVerificationResult'
        issuer:
          type: string
          description: The VC issuer DID.
        credential_type:
          type: string

    ProofVerificationResult:
      type: object
      additionalProperties: false
      required: [verification_method, valid]
      properties:
        verification_method:
          type: string
          description: DID URL of the verification method used.
        valid:
          type: boolean
        error:
          type: string
          description: Error message if verification failed.
