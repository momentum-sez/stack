# MEZ Stack — Two-Zone Sovereign Deployment Compose
#
# Deploys two independent MEZ zones, each with its own sovereign Mass API
# stub instance and Postgres database. Zones communicate via the corridor
# network but Mass data never crosses zone boundaries.
#
# Architecture:
#   Zone A: mez-zone-a + postgres-a + mass-stub-a (zone-a-internal network)
#   Zone B: mez-zone-b + postgres-b + mass-stub-b (zone-b-internal network)
#   Corridor: zone-a <-> zone-b (mez-corridor-net)
#
# Data sovereignty: mass-stub-a is ONLY on zone-a-internal, mass-stub-b is
# ONLY on zone-b-internal. No cross-zone Mass data leakage by network topology.
#
# Environment variables (with defaults for backward compatibility):
#   ZONE_A_ZONE_ID     — Zone A identifier (default: org.momentum.mez.zone.pk-sifc)
#   ZONE_A_JURISDICTION — Zone A jurisdiction (default: pk)
#   ZONE_A_PROFILE      — Zone A profile (default: sovereign-govos)
#   ZONE_B_ZONE_ID     — Zone B identifier (default: org.momentum.mez.zone.ae-difc)
#   ZONE_B_JURISDICTION — Zone B jurisdiction (default: ae-difc)
#   ZONE_B_PROFILE      — Zone B profile (default: digital-financial-center)
#   CORRIDOR_ID         — Corridor identifier (default: auto-generated from jurisdictions)
#
# Usage:
#   # Default (PK-SIFC <-> AE-DIFC):
#   docker compose -f docker-compose.two-zone.yaml up -d
#
#   # Singapore <-> Hong Kong:
#   ZONE_A_ZONE_ID=org.momentum.mez.zone.sg ZONE_A_JURISDICTION=sg ZONE_A_PROFILE=digital-financial-center \
#   ZONE_B_ZONE_ID=org.momentum.mez.zone.hk ZONE_B_JURISDICTION=hk ZONE_B_PROFILE=digital-financial-center \
#   docker compose -f docker-compose.two-zone.yaml up -d

name: mez-two-zone

services:
  # ============================================
  # ZONE A — Sovereign Mass API Stub
  # ============================================

  mass-stub-a:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.mass-stub
    container_name: mez-mass-stub-a
    restart: unless-stopped
    environment:
      MASS_STUB_PORT: "8090"
      RUST_LOG: info
    networks:
      - zone-a-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # ============================================
  # ZONE A — MEZ API + Postgres
  # ============================================

  zone-a:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: mez-zone-a
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      MEZ_ZONE_ID: ${ZONE_A_ZONE_ID:-org.momentum.mez.zone.pk-sifc}
      MEZ_JURISDICTION: ${ZONE_A_JURISDICTION:-pk}
      MEZ_PROFILE: ${ZONE_A_PROFILE:-sovereign-govos}
      MEZ_HOST: "0.0.0.0"
      MEZ_PORT: "8080"
      MEZ_LOG_LEVEL: debug
      AUTH_TOKEN: ${ZONE_A_AUTH_TOKEN:?ZONE_A_AUTH_TOKEN must be set}
      DATABASE_URL: "postgresql://mez:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}@postgres-a:5432/mez"
      MEZ_CORRIDOR_ID: ${CORRIDOR_ID:-org.momentum.mez.corridor.cross-border}
      MEZ_WATCHER_ID: watcher-a-001
      MEZ_BOND_AMOUNT: "100000"
      MEZ_METRICS_ENABLED: "true"
      # Sovereign Mass API: zone-local stub, not centralized mass.inc
      MASS_ORG_INFO_URL: "http://mass-stub-a:8090"
      MASS_TREASURY_INFO_URL: "http://mass-stub-a:8090"
      MASS_CONSENT_INFO_URL: "http://mass-stub-a:8090"
      MASS_INVESTMENT_INFO_URL: "http://mass-stub-a:8090"
      MASS_TEMPLATING_URL: "http://mass-stub-a:8090"
      MASS_API_TOKEN: "sovereign-zone-a-token"
    depends_on:
      postgres-a:
        condition: service_healthy
      mass-stub-a:
        condition: service_healthy
    networks:
      - mez-corridor-net
      - zone-a-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  postgres-a:
    image: postgres:16-alpine
    container_name: mez-postgres-a
    restart: unless-stopped
    environment:
      POSTGRES_USER: mez
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: mez
    volumes:
      - postgres-a-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - zone-a-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mez -d mez"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # ============================================
  # ZONE B — Sovereign Mass API Stub
  # ============================================

  mass-stub-b:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.mass-stub
    container_name: mez-mass-stub-b
    restart: unless-stopped
    environment:
      MASS_STUB_PORT: "8090"
      RUST_LOG: info
    networks:
      - zone-b-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # ============================================
  # ZONE B — MEZ API + Postgres
  # ============================================

  zone-b:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: mez-zone-b
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      MEZ_ZONE_ID: ${ZONE_B_ZONE_ID:-org.momentum.mez.zone.ae-difc}
      MEZ_JURISDICTION: ${ZONE_B_JURISDICTION:-ae-difc}
      MEZ_PROFILE: ${ZONE_B_PROFILE:-digital-financial-center}
      MEZ_HOST: "0.0.0.0"
      MEZ_PORT: "8080"
      MEZ_LOG_LEVEL: debug
      AUTH_TOKEN: ${ZONE_B_AUTH_TOKEN:?ZONE_B_AUTH_TOKEN must be set}
      DATABASE_URL: "postgresql://mez:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}@postgres-b:5432/mez"
      MEZ_CORRIDOR_ID: ${CORRIDOR_ID:-org.momentum.mez.corridor.cross-border}
      MEZ_WATCHER_ID: watcher-b-001
      MEZ_BOND_AMOUNT: "100000"
      MEZ_METRICS_ENABLED: "true"
      # Sovereign Mass API: zone-local stub, not centralized mass.inc
      MASS_ORG_INFO_URL: "http://mass-stub-b:8090"
      MASS_TREASURY_INFO_URL: "http://mass-stub-b:8090"
      MASS_CONSENT_INFO_URL: "http://mass-stub-b:8090"
      MASS_INVESTMENT_INFO_URL: "http://mass-stub-b:8090"
      MASS_TEMPLATING_URL: "http://mass-stub-b:8090"
      MASS_API_TOKEN: "sovereign-zone-b-token"
    depends_on:
      postgres-b:
        condition: service_healthy
      mass-stub-b:
        condition: service_healthy
    networks:
      - mez-corridor-net
      - zone-b-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  postgres-b:
    image: postgres:16-alpine
    container_name: mez-postgres-b
    restart: unless-stopped
    environment:
      POSTGRES_USER: mez
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: mez
    volumes:
      - postgres-b-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - zone-b-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mez -d mez"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

# ============================================
# NETWORKS
# ============================================

networks:
  # Shared network for inter-zone corridor communication.
  # Both zones can reach each other via container names (zone-a, zone-b).
  # Mass stubs are NOT on this network — sovereign data residency.
  mez-corridor-net:
    driver: bridge
    name: mez-corridor-net

  # Zone-internal networks (DB + Mass stub access only within zone).
  zone-a-internal:
    driver: bridge
    name: mez-zone-a-internal
  zone-b-internal:
    driver: bridge
    name: mez-zone-b-internal

# ============================================
# VOLUMES
# ============================================

volumes:
  postgres-a-data:
  postgres-b-data:
