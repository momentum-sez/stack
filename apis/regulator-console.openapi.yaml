openapi: 3.1.0
info:
  title: MEZ Regulator Console API
  version: 0.4.44
  description: |
    Role-gated, auditable query endpoints for regulatory oversight.
    All requests are logged in an immutable audit trail.

    Provides attestation queries, compliance summaries, real-time
    dashboard, and per-entity compliance posture with optional
    corridor compliance breakdown.
  license:
    name: BUSL-1.1
    identifier: BUSL-1.1

servers:
  - url: https://{zone_host}/api
    variables:
      zone_host:
        default: localhost:8080

security:
  - bearerAuth: []

paths:
  /v1/regulator/query/attestations:
    post:
      summary: Query attestations with policy-based access control
      operationId: queryAttestations
      description: |
        Returns attestation records matching the filter criteria.
        Requires Regulator role. All queries are logged to the audit trail.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryAttestationsRequest'
      responses:
        '200':
          description: Attestation query results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResultsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/regulator/summary:
    get:
      summary: Compliance summary counts
      operationId: complianceSummary
      description: |
        Returns aggregate counts of entities, corridors, assets, and
        attestations in the zone. Requires Regulator role.
      responses:
        '200':
          description: Compliance summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/regulator/dashboard:
    get:
      summary: Full regulator dashboard
      operationId: regulatorDashboard
      description: |
        Returns a comprehensive regulator dashboard with zone status,
        compliance posture, corridor overview, policy activity, and
        system health metrics. Requires Regulator role.
      responses:
        '200':
          description: Regulator dashboard
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegulatorDashboard'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/compliance/{entity_id}:
    get:
      summary: Per-entity compliance posture
      operationId: getEntityCompliance
      description: |
        Returns the compliance posture for a specific entity, aggregated
        from attestation records and smart asset compliance evaluations.
        Reports the most recent attestation status per domain, associated
        asset compliance, and an overall entity compliance state.

        When the `corridors` query parameter is set to `true`, includes
        per-corridor compliance summaries with receipt chain height,
        MMR roots, and checkpoint timestamps.
      parameters:
        - name: entity_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Entity identifier (UUID).
        - name: corridors
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: When true, include per-corridor compliance summaries.
      responses:
        '200':
          description: Entity compliance posture
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EntityComplianceResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Entity not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Zone-issued JWT with role claims. Requires Regulator role.

  responses:
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    Forbidden:
      description: Insufficient regulatory permissions for this query
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    UnprocessableEntity:
      description: Schema validation failed or business rule violation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'

  schemas:
    ProblemDetail:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs.
      additionalProperties: false
      required: [type, title, status]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri

    QueryAttestationsRequest:
      type: object
      additionalProperties: false
      properties:
        jurisdiction_id:
          type: string
          description: Filter by jurisdiction.
        entity_id:
          type: string
          format: uuid
          description: Filter by entity.
        attestation_type:
          type: string
          description: Filter by attestation type.
        status:
          type: string
          enum: [valid, expired, revoked]
          description: Filter by attestation status.
        limit:
          type: integer
          minimum: 1
          maximum: 1000
          default: 100
          description: Maximum number of results.
        offset:
          type: integer
          minimum: 0
          default: 0
          description: Number of results to skip.

    QueryResultsResponse:
      type: object
      additionalProperties: false
      required: [count, total, results]
      properties:
        count:
          type: integer
          minimum: 0
          description: Number of results in this page.
        total:
          type: integer
          minimum: 0
          description: Total matching results.
        results:
          type: array
          items:
            $ref: '#/components/schemas/AttestationRecord'

    AttestationRecord:
      type: object
      additionalProperties: false
      required: [id, entity_id, attestation_type, issuer, status, jurisdiction_id, issued_at]
      properties:
        id:
          type: string
          format: uuid
        entity_id:
          type: string
          format: uuid
        attestation_type:
          type: string
        issuer:
          type: string
        status:
          type: string
          enum: [valid, expired, revoked]
        jurisdiction_id:
          type: string
        issued_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        details:
          type: object
          description: Attestation-specific details.

    ComplianceSummary:
      type: object
      additionalProperties: false
      required: [total_entities, total_corridors, total_assets, total_attestations]
      properties:
        total_entities:
          type: integer
          minimum: 0
        total_corridors:
          type: integer
          minimum: 0
        total_assets:
          type: integer
          minimum: 0
        total_attestations:
          type: integer
          minimum: 0

    RegulatorDashboard:
      type: object
      additionalProperties: false
      required: [zone, compliance, corridors, policy_activity, health]
      properties:
        zone:
          $ref: '#/components/schemas/ZoneStatus'
        compliance:
          $ref: '#/components/schemas/CompliancePosture'
        corridors:
          $ref: '#/components/schemas/CorridorOverview'
        policy_activity:
          $ref: '#/components/schemas/PolicyActivity'
        health:
          $ref: '#/components/schemas/SystemHealth'

    ZoneStatus:
      type: object
      additionalProperties: false
      required: [zone_did, zone_public_key, snapshot_at, entity_count, corridor_count, asset_count, attestation_count]
      properties:
        zone_id:
          type: string
        jurisdiction_id:
          type: string
        zone_did:
          type: string
        zone_public_key:
          type: string
        snapshot_at:
          type: string
          format: date-time
        domain_count:
          type: integer
          minimum: 0
        applicable_domains:
          type: array
          items:
            type: string
        entity_count:
          type: integer
          minimum: 0
        corridor_count:
          type: integer
          minimum: 0
        asset_count:
          type: integer
          minimum: 0
        attestation_count:
          type: integer
          minimum: 0

    CompliancePosture:
      type: object
      additionalProperties: false
      required: [assets, fully_compliant_count, has_blocking_count, all_pending_count]
      properties:
        assets:
          type: array
          items:
            $ref: '#/components/schemas/AssetComplianceSnapshot'
        fully_compliant_count:
          type: integer
          minimum: 0
        has_blocking_count:
          type: integer
          minimum: 0
        all_pending_count:
          type: integer
          minimum: 0

    AssetComplianceSnapshot:
      type: object
      additionalProperties: false
      required: [asset_id, asset_type, jurisdiction_id, compliance_status]
      properties:
        asset_id:
          type: string
          format: uuid
        asset_type:
          type: string
        jurisdiction_id:
          type: string
        compliance_status:
          type: string
          enum: [Compliant, NonCompliant, Pending, Unevaluated]
        last_evaluated:
          type: string

    CorridorOverview:
      type: object
      additionalProperties: false
      required: [corridors, by_state, total_receipts]
      properties:
        corridors:
          type: array
          items:
            $ref: '#/components/schemas/CorridorStatus'
        by_state:
          type: object
          additionalProperties:
            type: integer
          description: Corridor count grouped by lifecycle state.
        total_receipts:
          type: integer
          minimum: 0

    CorridorStatus:
      type: object
      additionalProperties: false
      required: [corridor_id, jurisdiction_a, jurisdiction_b, state, transition_count]
      properties:
        corridor_id:
          type: string
          format: uuid
        jurisdiction_a:
          type: string
        jurisdiction_b:
          type: string
        state:
          type: string
        transition_count:
          type: integer
          minimum: 0
        last_transition:
          type: string
          format: date-time
        receipt_chain_height:
          type: integer
          minimum: 0
        mmr_root:
          type: string

    PolicyActivity:
      type: object
      additionalProperties: false
      required: [policy_count, audit_trail_size, recent_entries]
      properties:
        policy_count:
          type: integer
          minimum: 0
        audit_trail_size:
          type: integer
          minimum: 0
        recent_entries:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntrySummary'

    AuditEntrySummary:
      type: object
      additionalProperties: false
      required: [entry_type, timestamp]
      properties:
        entry_type:
          type: string
        timestamp:
          type: string
          format: date-time
        asset_id:
          type: string
        digest:
          type: string

    SystemHealth:
      type: object
      additionalProperties: false
      required: [stale_draft_corridors, halted_corridors, assets_with_blocking_compliance, zone_key_ephemeral, total_requests, total_errors]
      properties:
        stale_draft_corridors:
          type: integer
          minimum: 0
        halted_corridors:
          type: integer
          minimum: 0
        assets_with_blocking_compliance:
          type: integer
          minimum: 0
        zone_key_ephemeral:
          type: boolean
        total_requests:
          type: integer
          minimum: 0
        total_errors:
          type: integer
          minimum: 0

    EntityComplianceResponse:
      type: object
      additionalProperties: false
      required: [entity_id, attestation_count, domains, assets, overall_status]
      properties:
        entity_id:
          type: string
          format: uuid
        jurisdiction_id:
          type: string
        attestation_count:
          type: integer
          minimum: 0
        domains:
          type: array
          items:
            $ref: '#/components/schemas/DomainComplianceStatus'
        assets:
          type: array
          items:
            $ref: '#/components/schemas/EntityAssetCompliance'
        overall_status:
          type: string
          enum: [compliant, non_compliant, pending]
        corridor_compliance:
          type: array
          description: Per-corridor compliance summaries. Present only when ?corridors=true.
          items:
            $ref: '#/components/schemas/CorridorComplianceStatus'

    DomainComplianceStatus:
      type: object
      additionalProperties: false
      required: [domain, status]
      properties:
        domain:
          type: string
          description: Compliance domain (kyc, aml, sanctions, tax, etc.).
        status:
          type: string
        issuer:
          type: string
        issued_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time

    EntityAssetCompliance:
      type: object
      additionalProperties: false
      required: [asset_id, asset_type, compliance_status]
      properties:
        asset_id:
          type: string
          format: uuid
        asset_type:
          type: string
        compliance_status:
          type: string
          enum: [Compliant, NonCompliant, Pending, Unevaluated]

    CorridorComplianceStatus:
      type: object
      additionalProperties: false
      required: [corridor_id, peer_zone, corridor_state, last_receipt_height]
      properties:
        corridor_id:
          type: string
          format: uuid
        peer_zone:
          type: string
        corridor_state:
          type: string
        last_receipt_height:
          type: integer
          minimum: 0
        last_checkpoint_time:
          type: string
          format: date-time
        mmr_root:
          type: string
