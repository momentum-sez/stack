# MEZ Stack — ExternalSecret (AWS Secrets Manager Integration)
#
# Uses the external-secrets-operator to sync secrets from AWS Secrets Manager
# into Kubernetes Secrets. This replaces static secret.yaml values with
# dynamically fetched production credentials.
#
# Prerequisites:
# 1. Install external-secrets-operator:
#    helm install external-secrets external-secrets/external-secrets \
#      -n external-secrets --create-namespace
# 2. Create a ClusterSecretStore pointing to AWS Secrets Manager.
# 3. Ensure the EKS node role or IRSA has secretsmanager:GetSecretValue.
#
# Apply: kubectl apply -f deploy/k8s/external-secrets.yaml

# ── ClusterSecretStore for AWS Secrets Manager ───────────────────────────
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  labels:
    app: mez-stack
    component: secrets
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      # IRSA: the external-secrets controller pod uses its service account
      # role to access Secrets Manager. No static credentials needed.

---

# ── ExternalSecret: Database credentials ─────────────────────────────────
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mez-db-credentials
  namespace: mez
  labels:
    app: mez-api
    component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: mez-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        database-url: "{{ .database_url }}"
        jwt-secret: "{{ .jwt_secret }}"
  data:
    - secretKey: database_url
      remoteRef:
        # AWS Secrets Manager secret name: mez/{zone_id}/database-url
        key: mez/production/database-url
    - secretKey: jwt_secret
      remoteRef:
        key: mez/production/jwt-secret

---

# ── ExternalSecret: Zone signing key ─────────────────────────────────────
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mez-signing-key
  namespace: mez
  labels:
    app: mez-api
    component: secrets
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: mez-signing-key
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        signing-key-hex: "{{ .signing_key }}"
  data:
    - secretKey: signing_key
      remoteRef:
        key: mez/production/zone-signing-key

---

# ── ExternalSecret: Mass API credentials ─────────────────────────────────
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mez-mass-credentials
  namespace: mez
  labels:
    app: mez-api
    component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: mez-mass-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        mass-api-token: "{{ .mass_token }}"
        auth-token: "{{ .auth_token }}"
  data:
    - secretKey: mass_token
      remoteRef:
        key: mez/production/mass-api-token
    - secretKey: auth_token
      remoteRef:
        key: mez/production/auth-token
