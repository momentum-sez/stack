# v0.4 spec patch list (text-based “unified diff” instructions)

> Format: each patch specifies an **exact “TEXT TO FIND”** anchor, then either a **REPLACE WITH** or an **INSERT AFTER** payload.

---

## PATCH 001 — Add `governance` as a first-class module kind

**TEXT TO FIND (exact):**
```
kind: Module category (legal, regulatory, licensing, financial, corridor, operational)
```

**REPLACE WITH:**
```
kind: Module category (legal, regulatory, licensing, financial, corridor, operational, governance)
```

**TEXT TO FIND (exact):**
```
4.4.6 Operational Modules
```

**INSERT AFTER:**
```
4.4.7 Governance Modules
governance/core — Interoperability schemas (proposals, votes, delegations, tallies)
governance/binary-voting — Yes/no voting (quorum + threshold)
governance/ranked-choice — RCV/STV voting
governance/approval-voting — Approval voting
governance/score-voting — Score voting
governance/quadratic-voting — Quadratic voting
governance/quadratic-funding — Quadratic funding
governance/liquid-democracy — Delegation + vote resolution semantics
governance/zk-participation — Privacy-preserving participation patterns (eligibility proofs, anonymous voting)
```

---

## PATCH 002 — Make Hash Computation normative and deterministic (JCS + YAML→JSON)

**TEXT TO FIND (exact):**
```
Content hashes are computed as SHA256 over the canonical (sorted, whitespace-normalized) JSON or YAML content.
```

**REPLACE WITH:**
```
Content hashes MUST be computed deterministically:

- For JSON artifacts: SHA256 over RFC 8785 JSON Canonicalization Scheme (JCS) output.
- For YAML artifacts: parse YAML into an equivalent JSON data model, then compute SHA256 over RFC 8785 JCS output.

For Verifiable Credentials (VCs), the signing input hash MUST be computed over the VC payload excluding `proof`,
canonicalized with RFC 8785 JCS. (This enables stable “definition payload” binding across re-issued signatures.)
```

**TEXT TO FIND (exact):**
```
The corridor definition VC includes these hashes, and signing the VC makes any tampering detectable.
```

**INSERT AFTER:**
```
Reference tool support:
- `mez vc payload-hash <vc.json>` prints `SHA256(JCS(vC_without_proof))`.
```

---

## PATCH 003 — Expand Lockfile Semantics with concrete fields + agreement-set digest algorithm

**TEXT TO FIND (exact):**
```
The stack.lock file records the exact state of a jurisdiction deployment including: stack spec version, generation
timestamp, zone identifier, profile reference, locked module versions with manifest and content hashes, applied
overlay hashes, and corridor configuration including definition VC digests, agreement VC digests, signer information,
activation status, agreement set digests, per-file payload hashes, and activation blockers.
```

**INSERT AFTER:**
```
Corridor lock entries MUST include (at minimum):

- corridor_id
- corridor_manifest_sha256
- trust_anchors_sha256
- key_rotation_sha256
- corridor_definition_vc_sha256 (hash of the VC file including `proof`)
- corridor_definition_signers (DID(s) observed in proof(s))

If a corridor is configured with agreement VC(s), lock entries MUST additionally include:

- corridor_agreement_vc_sha256[] (hash of each agreement VC file including `proof`)
- corridor_agreement_signers[] (DID(s) observed in proof(s))
- corridor_activated (boolean)
- corridor_activation_blockers[] (list of `<partyDid>:<commitment>` blockers)

To make corridor activation cryptographically meaningful (not merely declarative), lock entries MUST also record:

- corridor_agreement_payload_sha256_by_path: mapping of relative path → SHA256(JCS(agreement_vc_without_proof))
- corridor_agreement_set_sha256: SHA256(JCS({
    corridor_id,
    definition_payload_sha256,
    agreement_payload_sha256: [sorted list]
  }))

Where:
- definition_payload_sha256 = SHA256(JCS(definition_vc_without_proof))
- agreement_payload_sha256 are sorted lexicographically before digesting.

This ensures tamper-evident detection of edits even if `proof` is re-issued.
```

---

## PATCH 004 — Make Activation Blockers observable (CLI + lockfile)

**TEXT TO FIND (exact):**
```
Validation output includes corridor_activation_blockers listing any <partyDid>:<commitment> blockers.
```

**INSERT AFTER:**
```
Operationally, activation blockers MUST be observable via:

- lockfile generation (stack.lock records corridor_activation_blockers)
- a status command that summarizes activation readiness across an agreement-set

Implementations SHOULD expose a machine-readable status output that includes:
- activated (boolean)
- blocked_parties[] (non-affirmative parties)
- corridor_activation_blockers[] (strings in `<partyDid>:<commitment>` format)
```

---

## PATCH 005 — Reference governance module IDs + interfaces (make Part VII implementable)

**TEXT TO FIND (exact):**
```
PART VII: CIVIC GOVERNANCE INFRASTRUCTURE
This section specifies modules for civic governance structures that enable democratic accountability within
programmable institutions.
```

**INSERT AFTER:**
```
Reference repository mapping (recommended):

| Concept | Module ID | Interface |
|---|---|---|
| Governance core schemas | org.momentum.mez.governance.core | mez.gov.proposal.v1 / mez.gov.vote.v1 / mez.gov.delegation.v1 / mez.gov.tally.v1 |
| Binary voting | org.momentum.mez.governance.binary-voting | mez.gov.mechanism.binary-voting.v1 |
| Ranked choice | org.momentum.mez.governance.ranked-choice | mez.gov.mechanism.ranked-choice.v1 |
| Approval voting | org.momentum.mez.governance.approval-voting | mez.gov.mechanism.approval-voting.v1 |
| Score voting | org.momentum.mez.governance.score-voting | mez.gov.mechanism.score-voting.v1 |
| Quadratic voting | org.momentum.mez.governance.quadratic-voting | mez.gov.mechanism.quadratic-voting.v1 |
| Quadratic funding | org.momentum.mez.governance.quadratic-funding | mez.gov.mechanism.quadratic-funding.v1 |
| Liquid democracy | org.momentum.mez.governance.liquid-democracy | mez.gov.mechanism.liquid-democracy.v1 |
| ZK participation | org.momentum.mez.governance.zk-participation | mez.gov.mechanism.zk-participation.v1 |

All governance mechanism modules SHOULD depend on `org.momentum.mez.governance.core` for shared schemas.
```

---

## PATCH 006 — Reference diffusion/experimentation module IDs + interfaces (make Part VIII implementable)

**TEXT TO FIND (exact):**
```
8.3.1 Deployment Telemetry
```

**INSERT BEFORE:**
```
Reference repository mapping (recommended):

| Capability | Module ID | Interface |
|---|---|---|
| Deployment telemetry event schema | org.momentum.mez.ops.deployment-telemetry | mez.ops.telemetry-event.v1 |
| Success metric registry schema + starter registry | org.momentum.mez.ops.success-metric-registry | mez.ops.success-metric.v1 |
| Experiment descriptor schema | org.momentum.mez.ops.ab-testing-framework | mez.ops.experiment.v1 |

These modules are intentionally thin: they standardize data models so different implementations remain interoperable.
```

---

## PATCH 007 — Add missing reference CLI commands (`corridor status`, `lock`)

**TEXT TO FIND (exact):**
```
mez corridor verify modules/corridors/swift
```

**INSERT AFTER:**
```
mez corridor status modules/corridors/swift
mez lock --zone jurisdictions/<zone>/zone.yaml --out stack.lock
```

---

## PATCH 008 — Make corridor agreement-set digest a first-class audit handle

**TEXT TO FIND (exact):**
```
5.3 Corridor Agreement Verifiable Credentials
```

**INSERT AFTER:**
```
Audit handle (recommended):
- For any activated corridor, systems SHOULD reference the corridor_agreement_set_sha256 digest in audit logs,
  regulator-console views, and cross-zone sync messages. This provides a stable content-addressed identifier for
  “the currently active agreement-set” even as proofs are re-issued.
```

