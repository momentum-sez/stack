# MSEZ Stack — Docker Compose (Rust Binary Architecture)
#
# Replaces the previous 12-service Python-based compose that referenced
# non-existent `serve` subcommands. The Rust architecture consolidates
# all five primitive API services into a single msez-api binary (Axum),
# with PostgreSQL for persistence and Prometheus/Grafana for observability.
#
# Previous setup: 9 Python services (zone-authority, entity-registry,
#   license-registry, corridor-node, watcher, identity-service,
#   settlement-service, compliance-service, regulator-console) — none
#   of which could start because the `serve` CLI subcommands did not exist.
#
# Current setup: 1 Rust API server exposing all endpoints on port 8080,
#   with PostgreSQL, Prometheus, and Grafana as supporting infrastructure.
#
# Usage:
#   docker compose up -d                           # Start all services
#   docker compose logs -f msez-api                # Follow API logs
#   docker compose exec msez-api msez-cli validate --all-modules  # Run validation
#   docker compose down                            # Stop all services
#   docker compose down -v                         # Stop and remove volumes

name: msez-zone

services:
  # ============================================
  # APPLICATION
  # ============================================

  # msez-api: Axum HTTP server serving all five primitive APIs
  # (Entities, Ownership, Fiscal, Identity, Consent), corridor operations,
  # smart asset CRUD, compliance evaluation, and regulator console.
  msez-api:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: msez-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Zone configuration
      MSEZ_ZONE_ID: ${MSEZ_ZONE_ID:-org.momentum.msez.zone.local}
      MSEZ_JURISDICTION: ${MSEZ_JURISDICTION:-ex}
      MSEZ_PROFILE: ${MSEZ_PROFILE:-digital-financial-center}
      # Server
      MSEZ_HOST: "0.0.0.0"
      MSEZ_PORT: "8080"
      MSEZ_LOG_LEVEL: ${MSEZ_LOG_LEVEL:-info}
      # Database (PostgreSQL via SQLx)
      DATABASE_URL: "postgresql://msez:${POSTGRES_PASSWORD:-msez}@postgres:5432/msez"
      # Corridor configuration
      MSEZ_CORRIDOR_ID: ${MSEZ_CORRIDOR_ID:-org.momentum.msez.corridor.local}
      # Watcher configuration
      MSEZ_WATCHER_ID: ${MSEZ_WATCHER_ID:-watcher-local-001}
      MSEZ_BOND_AMOUNT: ${MSEZ_BOND_AMOUNT:-100000}
      # JWT signing (mount key file or set via env)
      MSEZ_JWT_SECRET_FILE: /app/config/jwt-secret
      # Metrics
      MSEZ_METRICS_ENABLED: "true"
    volumes:
      - api-data:/app/data
      - api-config:/app/config
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - msez-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/liveness"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ============================================
  # DATABASE
  # ============================================

  # PostgreSQL 16 — primary data store
  # Schema initialized via init-db.sql; runtime migrations via SQLx.
  postgres:
    image: postgres:16-alpine
    container_name: msez-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: msez
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-msez}
      POSTGRES_DB: msez
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    ports:
      - "5432:5432"
    networks:
      - msez-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U msez -d msez"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # OBSERVABILITY
  # ============================================

  # Prometheus — metrics collection from msez-api /metrics endpoint
  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: msez-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus.yaml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - msez-internal
    depends_on:
      - msez-api
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'

  # Grafana — metrics visualization
  grafana:
    image: grafana/grafana:10.4.1
    container_name: msez-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - msez-internal
    depends_on:
      - prometheus

# ============================================
# NETWORKS
# ============================================

networks:
  msez-internal:
    driver: bridge
    name: msez-internal

# ============================================
# VOLUMES
# ============================================

volumes:
  api-data:
  api-config:
  postgres-data:
  prometheus-data:
  grafana-data:
