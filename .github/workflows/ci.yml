name: ci
on:
  push:
  pull_request:

jobs:
  rust:
    name: Rust workspace checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: msez
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: msez

      - name: Check formatting
        run: cargo fmt --check --all

      - name: Clippy (warnings as errors)
        run: cargo clippy --workspace -- -D warnings

      - name: Guard — serde_json preserve_order must NOT be enabled
        run: |
          if cargo tree -e features -i serde_json 2>&1 | grep -qi "preserve.order\|indexmap"; then
            echo "FATAL: serde_json preserve_order detected — all digests would be corrupted"
            cargo tree -e features -i serde_json
            exit 1
          fi
          echo "OK: serde_json uses BTreeMap (preserve_order not active)"

      - name: Run tests
        run: cargo test --workspace

      - name: Security audit
        run: |
          cargo install cargo-audit --locked
          cargo audit

      - name: Build docs
        run: cargo doc --workspace --no-deps

  schema-validation:
    name: Schema & artifact integrity checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: msez

      # P1-SCHEMA-001: Validate schemas with Draft 2020-12 compilation + $ref closure.
      # Replaces old Python json.load() parse check. The Rust SchemaValidator
      # compiles every *.schema.json with Draft 2020-12, resolves all $ref URIs,
      # and reports structural/compile errors.
      - name: Validate all schemas (Draft 2020-12 + $ref closure)
        working-directory: msez
        run: cargo test --package msez-schema -- test_load_all_schemas test_ref_resolution

      # P1-SCHEMA-002: Schema $id URI consistency (hard failure).
      # All schemas must use the canonical domain: schemas.momentum-sez.org/msez/
      - name: Guard — schema $id URI consistency
        run: |
          CANONICAL="schemas.momentum-sez.org/msez/"
          BAD_IDS=$(grep -rn '"$id"' schemas/ | grep -v "$CANONICAL" | grep -v '.schema.json":' || true)
          if [ -n "$BAD_IDS" ]; then
            echo "FAIL: Non-canonical schema \$id URIs found (P1-SCHEMA-002):"
            echo "$BAD_IDS"
            echo "Expected domain: $CANONICAL"
            exit 1
          fi
          echo "OK: All schema \$id URIs use canonical domain"

      # P0-DEPLOY-001: No default credentials in deploy paths.
      - name: Guard — no default credentials in deploy paths
        run: |
          if grep -rn 'POSTGRES_PASSWORD:-msez\|POSTGRES_PASSWORD=msez\|GRAFANA_PASSWORD:-admin\|password.*=.*msez' deploy/; then
            echo "FAIL: Default credentials found in deploy paths (P0-DEPLOY-001)"
            exit 1
          fi
          echo "OK: No default credentials in deploy paths"

      # P0-ZK-001: Release builds must not enable mock proof features.
      - name: Guard — no mock proof backend in release
        working-directory: msez
        run: |
          FEATURES=$(cargo metadata --format-version 1 --no-deps 2>/dev/null | \
            python3 -c "import sys,json; pkgs=json.load(sys.stdin)['packages']; zkp=[p for p in pkgs if p['name']=='msez-zkp']; print(zkp[0]['features'] if zkp else '{}')" 2>/dev/null || echo "{}")
          if echo "$FEATURES" | grep -qi "mock"; then
            echo "WARNING: msez-zkp has mock-related features: $FEATURES"
            echo "Ensure mock features are NOT enabled in release profile"
          fi
          echo "OK: Mock proof backend check complete"

      # P1-SCHEMA-003: additionalProperties policy on security-critical schemas.
      - name: Guard — additionalProperties policy on security-critical schemas
        working-directory: msez
        run: cargo test --package msez-schema -- test_audit_current_schema_state

      - name: Verify trade playbook artifact graph closure
        run: |
          test -f docs/examples/trade/dist/artifacts/cas-index.json || { echo "SKIP: trade playbook artifacts not present"; exit 0; }
          test -f docs/examples/trade/dist/manifest.playbook.root.json
          test -f docs/examples/trade/dist/dashboard.json
          echo "OK: Trade playbook artifact closure verified"
