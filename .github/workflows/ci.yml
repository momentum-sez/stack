name: ci
on:
  push:
  pull_request:

jobs:
  rust:
    name: Rust workspace checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: msez
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: msez

      - name: Check formatting
        run: cargo fmt --check --all

      - name: Clippy (warnings as errors)
        run: cargo clippy --workspace -- -D warnings

      - name: Guard — serde_json preserve_order must NOT be enabled
        run: |
          if cargo tree -e features -i serde_json 2>&1 | grep -qi "preserve.order\|indexmap"; then
            echo "FATAL: serde_json preserve_order detected — all digests would be corrupted"
            cargo tree -e features -i serde_json
            exit 1
          fi
          echo "OK: serde_json uses BTreeMap (preserve_order not active)"

      - name: Run tests
        run: cargo test --workspace

      - name: Security audit
        run: |
          cargo install cargo-audit --locked
          cargo audit

      - name: Build docs
        run: cargo doc --workspace --no-deps

  schema-validation:
    name: Schema & artifact integrity checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify all JSON schemas are valid
        run: |
          for f in schemas/*.json; do
            python3 -c "import json; json.load(open('$f'))" 2>/dev/null || {
              echo "FAIL: $f is not valid JSON"
              exit 1
            }
          done
          echo "OK: All schemas are valid JSON"

      - name: Guard — no default credentials in deploy paths
        run: |
          if grep -rn 'POSTGRES_PASSWORD:-msez\|POSTGRES_PASSWORD=msez\|GRAFANA_PASSWORD:-admin' deploy/; then
            echo "FAIL: Default credentials found in deploy paths (P0-DEPLOY-001)"
            exit 1
          fi
          echo "OK: No default credentials in deploy paths"

      - name: Guard — schema $id URI consistency
        run: |
          CANONICAL="schemas.momentum-sez.org/msez/"
          BAD_IDS=$(grep -rn '"$id"' schemas/ | grep -v "$CANONICAL" | grep -v '.schema.json":' || true)
          if [ -n "$BAD_IDS" ]; then
            echo "WARNING: Non-canonical schema \$id URIs found (P1-SCHEMA-002):"
            echo "$BAD_IDS"
            echo "Expected domain: $CANONICAL"
          fi
          echo "INFO: Schema \$id consistency check complete"

      - name: Verify trade playbook artifact graph closure
        run: |
          test -f docs/examples/trade/dist/artifacts/cas-index.json || { echo "SKIP: trade playbook artifacts not present"; exit 0; }
          test -f docs/examples/trade/dist/manifest.playbook.root.json
          test -f docs/examples/trade/dist/dashboard.json
          echo "OK: Trade playbook artifact closure verified"
