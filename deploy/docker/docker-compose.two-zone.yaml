# MEZ Stack — Two-Zone Sovereign Deployment Compose
#
# Deploys two independent MEZ zones, each with its own Postgres database.
# Each zone serves Mass primitive endpoints directly from the mez-api
# process (SOVEREIGN_MASS=true, ADR-007) with Postgres-backed persistence.
# No separate mass-stub containers — 4 containers total (2x mez-api + 2x postgres).
#
# Architecture:
#   Zone A: mez-zone-a + postgres-a
#   Zone B: mez-zone-b + postgres-b
#   Corridor: zone-a <-> zone-b (mez-corridor-net)
#
# Data sovereignty: each zone's Postgres is local; Mass data never crosses
# zone boundaries by design.
#
# Environment variables (with defaults for backward compatibility):
#   ZONE_A_ZONE_ID     — Zone A identifier (default: org.momentum.mez.zone.pk-sifc)
#   ZONE_A_JURISDICTION — Zone A jurisdiction (default: pk)
#   ZONE_A_PROFILE      — Zone A profile (default: sovereign-govos-pk)
#   ZONE_B_ZONE_ID     — Zone B identifier (default: org.momentum.mez.zone.ae-difc)
#   ZONE_B_JURISDICTION — Zone B jurisdiction (default: ae-difc)
#   ZONE_B_PROFILE      — Zone B profile (default: digital-financial-center)
#   CORRIDOR_ID         — Corridor identifier (default: auto-generated from jurisdictions)
#
# Usage:
#   # Default (PK-SIFC <-> AE-DIFC):
#   docker compose -f docker-compose.two-zone.yaml up -d
#
#   # Singapore <-> Hong Kong:
#   ZONE_A_ZONE_ID=org.momentum.mez.zone.sg ZONE_A_JURISDICTION=sg ZONE_A_PROFILE=digital-financial-center \
#   ZONE_B_ZONE_ID=org.momentum.mez.zone.hk ZONE_B_JURISDICTION=hk ZONE_B_PROFILE=digital-financial-center \
#   docker compose -f docker-compose.two-zone.yaml up -d

name: mez-two-zone

services:
  # ============================================
  # ZONE A — MEZ API (sovereign Mass) + Postgres
  # ============================================

  zone-a:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: mez-zone-a
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      MEZ_ZONE_ID: ${ZONE_A_ZONE_ID:-org.momentum.mez.zone.pk-sifc}
      MEZ_JURISDICTION: ${ZONE_A_JURISDICTION:-pk}
      MEZ_PROFILE: ${ZONE_A_PROFILE:-sovereign-govos-pk}
      MEZ_HOST: "0.0.0.0"
      MEZ_PORT: "8080"
      MEZ_LOG_LEVEL: debug
      AUTH_TOKEN: ${ZONE_A_AUTH_TOKEN:?ZONE_A_AUTH_TOKEN must be set}
      DATABASE_URL: "postgresql://mez:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}@postgres-a:5432/mez"
      MEZ_CORRIDOR_ID: ${CORRIDOR_ID:-org.momentum.mez.corridor.cross-border}
      MEZ_WATCHER_ID: watcher-a-001
      MEZ_BOND_AMOUNT: "100000"
      MEZ_METRICS_ENABLED: "true"
      # Sovereign Mass: served by this mez-api process, Postgres-backed (ADR-007).
      SOVEREIGN_MASS: "true"
      # Mass client URLs point to self — same process serves Mass routes.
      MASS_ORG_INFO_URL: "http://localhost:8080"
      MASS_TREASURY_INFO_URL: "http://localhost:8080"
      MASS_CONSENT_INFO_URL: "http://localhost:8080"
      MASS_INVESTMENT_INFO_URL: "http://localhost:8080"
      MASS_TEMPLATING_URL: "http://localhost:8080"
      MASS_API_TOKEN: "sovereign-zone-a-token"
    depends_on:
      postgres-a:
        condition: service_healthy
    networks:
      - mez-corridor-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  postgres-a:
    image: postgres:16-alpine
    container_name: mez-postgres-a
    restart: unless-stopped
    environment:
      POSTGRES_USER: mez
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: mez
    volumes:
      - postgres-a-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - mez-corridor-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mez -d mez"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # ============================================
  # ZONE B — MEZ API (sovereign Mass) + Postgres
  # ============================================

  zone-b:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: mez-zone-b
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      MEZ_ZONE_ID: ${ZONE_B_ZONE_ID:-org.momentum.mez.zone.ae-difc}
      MEZ_JURISDICTION: ${ZONE_B_JURISDICTION:-ae-difc}
      MEZ_PROFILE: ${ZONE_B_PROFILE:-digital-financial-center}
      MEZ_HOST: "0.0.0.0"
      MEZ_PORT: "8080"
      MEZ_LOG_LEVEL: debug
      AUTH_TOKEN: ${ZONE_B_AUTH_TOKEN:?ZONE_B_AUTH_TOKEN must be set}
      DATABASE_URL: "postgresql://mez:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}@postgres-b:5432/mez"
      MEZ_CORRIDOR_ID: ${CORRIDOR_ID:-org.momentum.mez.corridor.cross-border}
      MEZ_WATCHER_ID: watcher-b-001
      MEZ_BOND_AMOUNT: "100000"
      MEZ_METRICS_ENABLED: "true"
      # Sovereign Mass: served by this mez-api process, Postgres-backed (ADR-007).
      SOVEREIGN_MASS: "true"
      # Mass client URLs point to self — same process serves Mass routes.
      MASS_ORG_INFO_URL: "http://localhost:8080"
      MASS_TREASURY_INFO_URL: "http://localhost:8080"
      MASS_CONSENT_INFO_URL: "http://localhost:8080"
      MASS_INVESTMENT_INFO_URL: "http://localhost:8080"
      MASS_TEMPLATING_URL: "http://localhost:8080"
      MASS_API_TOKEN: "sovereign-zone-b-token"
    depends_on:
      postgres-b:
        condition: service_healthy
    networks:
      - mez-corridor-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  postgres-b:
    image: postgres:16-alpine
    container_name: mez-postgres-b
    restart: unless-stopped
    environment:
      POSTGRES_USER: mez
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: mez
    volumes:
      - postgres-b-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - mez-corridor-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mez -d mez"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

# ============================================
# NETWORKS
# ============================================

networks:
  # Shared network for inter-zone corridor communication and DB access.
  # Both zones can reach each other via container names (zone-a, zone-b).
  # Each Postgres is accessible only by its owning zone (same network, but
  # no cross-zone DB credentials).
  mez-corridor-net:
    driver: bridge
    name: mez-corridor-net

# ============================================
# VOLUMES
# ============================================

volumes:
  postgres-a-data:
  postgres-b-data:
