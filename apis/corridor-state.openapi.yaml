openapi: 3.1.0
info:
  title: MEZ Corridor State API
  version: 0.4.44
  description: |
    Corridor state-channel operations: receipt proposals, fork resolution,
    anchoring, and finality status computation.

    These endpoints mirror the CLI subcommands under `mez corridor state ...`.
    All mutating endpoints are idempotent when called with the same
    `Idempotency-Key` header value.
  license:
    name: BUSL-1.1
    identifier: BUSL-1.1

tags:
  - name: corridor.state
    description: Corridor state-channel operations (receipts, proposals, forks, anchors, finality).

security:
  - bearerAuth: []

paths:
  /corridor/state/propose:
    post:
      tags: [corridor.state]
      summary: Propose the next corridor receipt
      description: Equivalent to `mez corridor state propose` (unsigned proposal artifact).
      operationId: proposeReceipt
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required: [corridor_id, sequence, prev_root, transition]
              properties:
                corridor_id:
                  type: string
                sequence:
                  type: integer
                  minimum: 0
                timestamp:
                  type: string
                  format: date-time
                  description: If omitted, the server MAY set it to now().
                prev_root:
                  type: string
                  pattern: '^[a-f0-9]{64}$'
                transition:
                  $ref: 'https://schemas.momentum-ez.org/mez/transition-envelope.schema.json'
                notes:
                  type: string
      responses:
        '200':
          description: Receipt proposal
          content:
            application/json:
              schema:
                $ref: 'https://schemas.momentum-ez.org/mez/corridor.receipt-proposal.schema.json'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Conflict â€” prev_root does not match current corridor head
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /corridor/state/fork-resolve:
    post:
      tags: [corridor.state]
      summary: Resolve a receipt fork
      description: Equivalent to `mez corridor state fork-resolve` (unsigned VC).
      operationId: resolveFork
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required: [corridor_id, sequence, prev_root, chosen_next_root, issuer]
              properties:
                corridor_id:
                  type: string
                sequence:
                  type: integer
                  minimum: 0
                prev_root:
                  type: string
                  pattern: '^[a-f0-9]{64}$'
                chosen_next_root:
                  type: string
                  pattern: '^[a-f0-9]{64}$'
                candidates:
                  type: array
                  items:
                    type: object
                    additionalProperties: false
                    required: [next_root]
                    properties:
                      next_root:
                        type: string
                        pattern: '^[a-f0-9]{64}$'
                      timestamp:
                        type: string
                        format: date-time
                      attestations:
                        type: array
                        items:
                          type: object
                issuer:
                  type: string
                  description: DID of the fork-resolution VC issuer.
      responses:
        '200':
          description: Fork-resolution Verifiable Credential
          content:
            application/json:
              schema:
                $ref: 'https://schemas.momentum-ez.org/mez/vc.corridor-fork-resolution.schema.json'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /corridor/state/anchor:
    post:
      tags: [corridor.state]
      summary: Anchor a corridor head commitment
      description: Equivalent to `mez corridor state anchor` (unsigned VC).
      operationId: anchorHead
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required: [corridor_id, head_commitment_digest_sha256, chain, issuer]
              properties:
                corridor_id:
                  type: string
                head_commitment_digest_sha256:
                  type: string
                  pattern: '^[a-f0-9]{64}$'
                chain:
                  type: object
                  additionalProperties: false
                  required: [network]
                  properties:
                    network:
                      type: string
                    chain_id:
                      type: string
                    tx_hash:
                      type: string
                    block_number:
                      type: integer
                      minimum: 0
                    block_hash:
                      type: string
                    block_timestamp:
                      type: string
                      format: date-time
                checkpoint_ref:
                  $ref: 'https://schemas.momentum-ez.org/mez/artifact-ref.schema.json'
                issuer:
                  type: string
      responses:
        '200':
          description: Corridor anchor Verifiable Credential
          content:
            application/json:
              schema:
                $ref: 'https://schemas.momentum-ez.org/mez/vc.corridor-anchor.schema.json'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

  /corridor/state/finality-status:
    post:
      tags: [corridor.state]
      summary: Compute corridor finality status for a head
      description: Equivalent to `mez corridor state finality-status`.
      operationId: computeFinalityStatus
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              required: [corridor_id, final_state_root, receipt_count, mmr_root, head_commitment_digest_sha256]
              properties:
                corridor_id:
                  type: string
                as_of:
                  type: string
                  format: date-time
                receipt_count:
                  type: integer
                  minimum: 0
                final_state_root:
                  type: string
                  pattern: '^[a-f0-9]{64}$'
                mmr_root:
                  type: string
                  pattern: '^[a-f0-9]{64}$'
                head_commitment_digest_sha256:
                  type: string
                  pattern: '^[a-f0-9]{64}$'
                evidence:
                  type: object
                  additionalProperties: false
                  properties:
                    checkpoint:
                      $ref: 'https://schemas.momentum-ez.org/mez/artifact-ref.schema.json'
                    watcher_quorum:
                      type: object
                      additionalProperties: false
                      properties:
                        required_count:
                          type: integer
                          minimum: 0
                        confirmed_count:
                          type: integer
                          minimum: 0
                        quorum_met:
                          type: boolean
                    anchors:
                      type: array
                      items:
                        $ref: 'https://schemas.momentum-ez.org/mez/artifact-ref.schema.json'
                    disputes:
                      type: array
                      items:
                        $ref: 'https://schemas.momentum-ez.org/mez/artifact-ref.schema.json'
      responses:
        '200':
          description: Finality status object
          content:
            application/json:
              schema:
                $ref: 'https://schemas.momentum-ez.org/mez/corridor.finality-status.schema.json'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Zone-issued JWT with role claims (operator, watcher, auditor).

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: Client-generated UUID for at-most-once delivery.
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Malformed request body or parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    UnprocessableEntity:
      description: Schema validation failed or business rule violation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'

  schemas:
    ProblemDetail:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs.
      additionalProperties: false
      required: [type, title, status]
      properties:
        type:
          type: string
          format: uri
          description: URI identifying the problem type.
        title:
          type: string
          description: Short human-readable summary.
        status:
          type: integer
          description: HTTP status code.
        detail:
          type: string
          description: Human-readable explanation specific to this occurrence.
        instance:
          type: string
          format: uri
          description: URI reference for this specific occurrence.

    TransitionEnvelope:
      $ref: 'https://schemas.momentum-ez.org/mez/transition-envelope.schema.json'
    CorridorReceiptProposal:
      $ref: 'https://schemas.momentum-ez.org/mez/corridor.receipt-proposal.schema.json'
    CorridorForkResolution:
      $ref: 'https://schemas.momentum-ez.org/mez/corridor.fork-resolution.schema.json'
    CorridorForkResolutionCredential:
      $ref: 'https://schemas.momentum-ez.org/mez/vc.corridor-fork-resolution.schema.json'
    CorridorAnchorCredential:
      $ref: 'https://schemas.momentum-ez.org/mez/vc.corridor-anchor.schema.json'
    CorridorFinalityStatus:
      $ref: 'https://schemas.momentum-ez.org/mez/corridor.finality-status.schema.json'
    CorridorLifecycle:
      $ref: 'https://schemas.momentum-ez.org/mez/corridor.lifecycle.schema.json'
    CorridorLifecycleTransitionCredential:
      $ref: 'https://schemas.momentum-ez.org/mez/vc.corridor-lifecycle-transition.schema.json'
    CorridorRoute:
      $ref: 'https://schemas.momentum-ez.org/mez/corridor.routing.schema.json'
    WatcherBondCredential:
      $ref: 'https://schemas.momentum-ez.org/mez/vc.watcher-bond.schema.json'
    DisputeClaimCredential:
      $ref: 'https://schemas.momentum-ez.org/mez/vc.dispute-claim.schema.json'
    ArbitrationAwardCredential:
      $ref: 'https://schemas.momentum-ez.org/mez/vc.arbitration-award.schema.json'
