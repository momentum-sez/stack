# MEZ Stack — Two-Zone Integration Test Compose
#
# Deploys two independent MEZ zones (PK-SIFC and AE-DIFC) that can
# establish an inter-zone corridor and exchange receipts over the
# internal Docker network.
#
# This compose file validates the P0-CORRIDOR-NET-001 inter-zone protocol:
#   1. Zone A (PK-SIFC) proposes a corridor to Zone B (AE-DIFC)
#   2. Zone B accepts the proposal
#   3. Both zones exchange receipts via the peer exchange API
#   4. Watcher attestations can be delivered between zones
#
# Usage:
#   docker compose -f docker-compose.two-zone.yaml up -d
#   # Wait for both zones to be healthy, then run the integration test:
#   ./scripts/test-two-zone.sh
#   docker compose -f docker-compose.two-zone.yaml down -v

name: mez-two-zone

services:
  # ============================================
  # ZONE A — Pakistan SIFC
  # ============================================

  zone-a:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: mez-zone-a
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      MEZ_ZONE_ID: org.momentum.mez.zone.pk-sifc
      MEZ_JURISDICTION: pk
      MEZ_PROFILE: sovereign-govos
      MEZ_HOST: "0.0.0.0"
      MEZ_PORT: "8080"
      MEZ_LOG_LEVEL: debug
      AUTH_TOKEN: ${ZONE_A_AUTH_TOKEN:-zone-a-test-token}
      DATABASE_URL: "postgresql://mez:${POSTGRES_PASSWORD:-testpw123}@postgres-a:5432/mez"
      MEZ_CORRIDOR_ID: org.momentum.mez.corridor.pk-ae.cross-border
      MEZ_WATCHER_ID: watcher-pk-001
      MEZ_BOND_AMOUNT: "100000"
      MEZ_METRICS_ENABLED: "true"
    depends_on:
      postgres-a:
        condition: service_healthy
    networks:
      - mez-corridor-net
      - zone-a-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  postgres-a:
    image: postgres:16-alpine
    container_name: mez-postgres-a
    restart: unless-stopped
    environment:
      POSTGRES_USER: mez
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-testpw123}
      POSTGRES_DB: mez
    volumes:
      - postgres-a-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - zone-a-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mez -d mez"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # ============================================
  # ZONE B — UAE DIFC
  # ============================================

  zone-b:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    container_name: mez-zone-b
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      MEZ_ZONE_ID: org.momentum.mez.zone.ae-difc
      MEZ_JURISDICTION: ae-difc
      MEZ_PROFILE: digital-financial-center
      MEZ_HOST: "0.0.0.0"
      MEZ_PORT: "8080"
      MEZ_LOG_LEVEL: debug
      AUTH_TOKEN: ${ZONE_B_AUTH_TOKEN:-zone-b-test-token}
      DATABASE_URL: "postgresql://mez:${POSTGRES_PASSWORD:-testpw123}@postgres-b:5432/mez"
      MEZ_CORRIDOR_ID: org.momentum.mez.corridor.pk-ae.cross-border
      MEZ_WATCHER_ID: watcher-ae-001
      MEZ_BOND_AMOUNT: "100000"
      MEZ_METRICS_ENABLED: "true"
    depends_on:
      postgres-b:
        condition: service_healthy
    networks:
      - mez-corridor-net
      - zone-b-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/liveness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  postgres-b:
    image: postgres:16-alpine
    container_name: mez-postgres-b
    restart: unless-stopped
    environment:
      POSTGRES_USER: mez
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-testpw123}
      POSTGRES_DB: mez
    volumes:
      - postgres-b-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - zone-b-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mez -d mez"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

# ============================================
# NETWORKS
# ============================================

networks:
  # Shared network for inter-zone corridor communication.
  # Both zones can reach each other via container names (zone-a, zone-b).
  mez-corridor-net:
    driver: bridge
    name: mez-corridor-net

  # Zone-internal networks (DB access only within zone).
  zone-a-internal:
    driver: bridge
    name: mez-zone-a-internal
  zone-b-internal:
    driver: bridge
    name: mez-zone-b-internal

# ============================================
# VOLUMES
# ============================================

volumes:
  postgres-a-data:
  postgres-b-data:
