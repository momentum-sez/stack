openapi: 3.1.0
info:
  title: MEZ Mass Node Integration API
  version: 0.4.44
  description: |
    Orchestration proxy for Zone Node â†” Mass Node communication.
    Provides entity management, ownership (cap tables), fiscal operations
    (accounts, payments), identity verification, and consent management.

    Write operations (POST/PUT) go through the MEZ compliance pipeline:
    compliance tensor evaluation, credential issuance, and attestation
    recording. The response wraps the Mass API response with compliance
    and credential metadata in an OrchestrationEnvelope.

    Returns 503 Service Unavailable when the Mass client is not configured.
  license:
    name: BUSL-1.1
    identifier: BUSL-1.1

servers:
  - url: https://{zone_host}/api
    variables:
      zone_host:
        default: localhost:8080

security:
  - bearerAuth: []

paths:
  /v1/entities:
    get:
      summary: List entities via Mass API
      operationId: listEntities
      responses:
        '200':
          description: Entity list from Mass API
          content:
            application/json:
              schema:
                type: object
                description: Raw Mass API response.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'
    post:
      summary: Create an entity with compliance orchestration
      operationId: createEntity
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEntityRequest'
      responses:
        '201':
          description: Entity created with compliance evaluation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationEnvelope'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/entities/{id}:
    get:
      summary: Get entity by ID via Mass API
      operationId: getEntity
      parameters:
        - $ref: '#/components/parameters/ResourceId'
      responses:
        '200':
          description: Entity details from Mass API
          content:
            application/json:
              schema:
                type: object
                description: Raw Mass API response.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'
    put:
      summary: Update an entity with compliance orchestration
      operationId: updateEntity
      parameters:
        - $ref: '#/components/parameters/ResourceId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEntityRequest'
      responses:
        '200':
          description: Entity updated with compliance evaluation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationEnvelope'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/ownership/cap-tables:
    post:
      summary: Create a cap table with compliance orchestration
      operationId: createCapTable
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCapTableRequest'
      responses:
        '201':
          description: Cap table created with compliance evaluation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationEnvelope'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/ownership/cap-tables/{id}:
    get:
      summary: Get cap table by ID via Mass API
      operationId: getCapTable
      parameters:
        - $ref: '#/components/parameters/ResourceId'
      responses:
        '200':
          description: Cap table details from Mass API
          content:
            application/json:
              schema:
                type: object
                description: Raw Mass API response.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/fiscal/accounts:
    post:
      summary: Create a fiscal account with compliance orchestration
      operationId: createAccount
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAccountRequest'
      responses:
        '201':
          description: Account created with compliance evaluation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationEnvelope'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/fiscal/payments:
    post:
      summary: Initiate a payment with compliance orchestration
      operationId: initiatePayment
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
      responses:
        '201':
          description: Payment initiated with compliance evaluation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationEnvelope'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/identity/verify:
    post:
      summary: Verify an identity with compliance orchestration
      operationId: verifyIdentity
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyIdentityRequest'
      responses:
        '200':
          description: Identity verified with compliance evaluation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationEnvelope'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/identity/{id}:
    get:
      summary: Get identity by ID via Mass API
      operationId: getIdentity
      parameters:
        - $ref: '#/components/parameters/ResourceId'
      responses:
        '200':
          description: Identity details from Mass API
          content:
            application/json:
              schema:
                type: object
                description: Raw Mass API response.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/consent:
    post:
      summary: Create a consent record with compliance orchestration
      operationId: createConsent
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConsentRequest'
      responses:
        '201':
          description: Consent created with compliance evaluation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationEnvelope'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/consent/{id}:
    get:
      summary: Get consent record by ID via Mass API
      operationId: getConsent
      parameters:
        - $ref: '#/components/parameters/ResourceId'
      responses:
        '200':
          description: Consent details from Mass API
          content:
            application/json:
              schema:
                type: object
                description: Raw Mass API response.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Zone-issued JWT with role claims (operator, regulator, auditor).

  parameters:
    ResourceId:
      name: id
      in: path
      required: true
      description: Resource UUID.
      schema:
        type: string
        format: uuid
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: Client-generated UUID for at-most-once delivery.
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Malformed request body or parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    UnprocessableEntity:
      description: Schema validation failed or business rule violation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    ServiceUnavailable:
      description: Mass client not configured or unreachable
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProblemDetail'

  schemas:
    ProblemDetail:
      type: object
      description: RFC 7807 Problem Details for HTTP APIs.
      additionalProperties: false
      required: [type, title, status]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri

    OrchestrationEnvelope:
      type: object
      additionalProperties: false
      required: [mass_response]
      description: |
        Wraps the Mass API response with EZ Stack compliance metadata.
        Write operations return this envelope; read operations return
        the raw Mass API response.
      properties:
        mass_response:
          type: object
          description: Raw response from the Mass API.
        compliance:
          type: object
          additionalProperties: false
          description: Compliance tensor evaluation result.
          properties:
            overall_status:
              type: string
            domain_results:
              type: array
              items:
                type: object
                additionalProperties: false
                properties:
                  domain:
                    type: string
                  status:
                    type: string
        credential:
          type: object
          description: Signed W3C Verifiable Credential (null if not passing).
        attestation_id:
          type: string
          format: uuid
          description: ID of the attestation record created.

    CreateEntityRequest:
      type: object
      additionalProperties: false
      required: [entity_type, legal_name, jurisdiction_id]
      properties:
        entity_type:
          type: string
          description: Entity type (e.g., LLC, Corp, DAO-LLC, Foundation).
        legal_name:
          type: string
          minLength: 1
        jurisdiction_id:
          type: string
        beneficial_owners:
          type: array
          items:
            $ref: '#/components/schemas/BeneficialOwnerInput'

    UpdateEntityRequest:
      type: object
      additionalProperties: false
      properties:
        legal_name:
          type: string
        entity_type:
          type: string
        jurisdiction_id:
          type: string
        beneficial_owners:
          type: array
          items:
            $ref: '#/components/schemas/BeneficialOwnerInput'
        address:
          type: string
        tags:
          type: array
          items:
            type: string

    BeneficialOwnerInput:
      type: object
      additionalProperties: false
      required: [name, ownership_percentage]
      properties:
        name:
          type: string
        ownership_percentage:
          type: string
          description: Ownership percentage as string (e.g., "25.5").
        cnic:
          type: string
          description: Pakistan CNIC (13 digits).
        ntn:
          type: string
          description: Pakistan NTN (7 digits).

    CreateCapTableRequest:
      type: object
      additionalProperties: false
      required: [entity_id, share_classes]
      properties:
        entity_id:
          type: string
          format: uuid
        share_classes:
          type: array
          items:
            $ref: '#/components/schemas/ShareClassInput'

    ShareClassInput:
      type: object
      additionalProperties: false
      required: [name, authorized_shares, issued_shares, voting_rights]
      properties:
        name:
          type: string
        authorized_shares:
          type: integer
          minimum: 0
        issued_shares:
          type: integer
          minimum: 0
        par_value:
          type: string
        voting_rights:
          type: boolean

    CreateAccountRequest:
      type: object
      additionalProperties: false
      required: [entity_id, account_type, currency]
      properties:
        entity_id:
          type: string
          format: uuid
        account_type:
          type: string
        currency:
          type: string
        ntn:
          type: string
          description: Pakistan NTN (7 digits) for tax withholding.

    CreatePaymentRequest:
      type: object
      additionalProperties: false
      required: [from_account_id, amount, currency, reference]
      properties:
        from_account_id:
          type: string
          format: uuid
        to_account_id:
          type: string
          format: uuid
        amount:
          type: string
          description: Payment amount as string.
        currency:
          type: string
        reference:
          type: string

    VerifyIdentityRequest:
      type: object
      additionalProperties: false
      required: [identity_type, linked_ids]
      properties:
        identity_type:
          type: string
        linked_ids:
          type: array
          items:
            $ref: '#/components/schemas/LinkedIdInput'

    LinkedIdInput:
      type: object
      additionalProperties: false
      required: [id_type, id_value]
      properties:
        id_type:
          type: string
        id_value:
          type: string

    CreateConsentRequest:
      type: object
      additionalProperties: false
      required: [consent_type, description, parties]
      properties:
        consent_type:
          type: string
        description:
          type: string
        parties:
          type: array
          items:
            $ref: '#/components/schemas/ConsentPartyInput'

    ConsentPartyInput:
      type: object
      additionalProperties: false
      required: [entity_id, role]
      properties:
        entity_id:
          type: string
          format: uuid
        role:
          type: string
